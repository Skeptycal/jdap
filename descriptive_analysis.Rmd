---
title: "Preliminary data analysis"
output: html_document
---

## Data pre-processing

Let's take a look at the numbers of responses by response date and publication date. Please keep in mind that the JDAP adoption dates used in the following analysis are approximate.

```{r, cache=TRUE, message=FALSE, echo=FALSE}

library(parsedate)
library(dplyr)
library(zoo)
library(ggplot2)
library(assertthat)

load("./data/JDAP 2_clean.rda")
load("./data/jdap_dates.rda")

# add the journal info to the main dataset
assert_that( all(d$journal %in% dates$journal) )
d <- left_join(d, dates, by="journal")

# format publication and response dates
d$PublicationDate <- parse_date(with(d, paste(month, year)))
d$ResponseDate <- parse_date(d$StartDate) %>% as.yearmon %>% as.POSIXct

d$ResponseDate_YM <- as.yearmon(d$ResponseDate) %>% as.character
d$ResponseDate_YQ <- as.yearqtr(d$ResponseDate) %>% as.character
d$ResponseDate_Y <- strftime(d$ResponseDate, "%Y") %>% as.character

d$PublicationDate_YM <- as.yearmon(d$PublicationDate) %>% as.character
d$PublicationDate_YQ <- as.yearqtr(d$PublicationDate) %>% as.character
d$PublicationDate_Y  <- strftime(d$PublicationDate, "%Y") %>% as.character

# determine time since JDAP introduction in the journal where the article was published
d$DaysPolicyToPublication <- difftime(d$PublicationDate, parse_date(d$policy_start), units="days")
d$DaysPolicyToResponse <- difftime(d$ResponseDate, parse_date(d$policy_start), units="days") 

d$PolicyAdoptedAtPublication <- ifelse(d$DaysPolicyToPublication>0, "After JDAP", "Before JDAP")
d$PolicyAdoptedAtResponse <- ifelse(d$DaysPolicyToResponse>0, "After JDAP", "Before JDAP")
d$PolicyAdoptedAtPublication[is.na(d$PolicyAdoptedAtPublication)] <- "No JDAP"
d$PolicyAdoptedAtResponse[is.na(d$PolicyAdoptedAtResponse)] <- "No JDAP"
d$PolicyBinary <- ifelse(d$policy=="Required", "JDAP", "No JDAP")

# number of responses by response date and journal policy in 2015
group_by(d, Date=ResponseDate_YQ, policy) %>% dplyr::summarize(N=length(StartDate)) %>% ggplot(aes(Date, N, color=policy, group=policy))+geom_point()+geom_line()+theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Number of participants by response date.")

# number of responses by publication date and journal policy in 2015
group_by(d, Date=PublicationDate_YQ, policy) %>% dplyr::summarize(N=length(PublicationDate)) %>% ggplot(aes(Date, N, color=policy, group=policy))+geom_point()+geom_line()+theme(axis.text.x = element_text(angle = 90, hjust = 1)) + ggtitle("Number of participants by publication date.")

# It seems to make more sense to focus on the publication date for plotting, until it is clear why there are hardly any responses from the second half of 2013.
```


## Critical questions


In the following, I will present an overview of the responses to questions 1 and 2. The questions asked about the strength of agreement/disagreement with the following statements:

* _Question 1_ It is the community norm in my field to share, with qualified researchers, datasets that support the results of peer-reviewed research articles. Include data sharing that occurs by any mechanism (e.g. emailing datasets upon request, posting datasets to lab websites, including datasets in journal supplementary information or data repositories).
* _Question 2_ It is the community norm in my field to publicly archive all supporting datasets online, for use by anyone for any purpose, upon publication of a peer-reviewed research article.


## Attitudes towards data sharing and archiving by journal type

The following plots show the responses regarding the attitudes towards data sharing and archiving by whether or not the journal has adopted a JDAP-equivalent data archiving policy by now (May 2015).

```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
source("src/multiplot.R")

x <- group_by(d, PolicyBinary, Response=Q4) %>% dplyr::summarize(N.resp=length(StartDate)) %>% filter(!is.na(Response)) %>% dplyr::mutate(N.total=sum(N.resp), P.resp=N.resp/N.total, Policy=sprintf("%s\n(N=%d)", PolicyBinary, N.total))
x <- x[order(x$Response, decreasing=T),]
p1 <- ggplot(data=x) + aes(Policy, P.resp*100, fill=Response, alpha=Response)+geom_bar(stat="identity")+ggtitle("'Data sharing is a community norm.'")+scale_fill_manual(values=c(rep("blue",3),"grey",rep("red",3)))+scale_alpha_manual(values=c(1,.75,.5,1,.5,.75,1))+theme_bw()+xlab("Current policy")+ylab("Percentage")


x <- group_by(d, PolicyBinary, Response=Q5) %>% dplyr::summarize(N.resp=length(StartDate)) %>% filter(!is.na(Response)) %>% dplyr::mutate(N.total=sum(N.resp), P.resp=N.resp/N.total, Policy=sprintf("%s\n(N=%d)", PolicyBinary, N.total))
x <- x[order(x$Response, decreasing=T),]
p2 <- ggplot(data=x) + aes(PolicyBinary, P.resp*100, fill=Response, alpha=Response)+geom_bar(stat="identity")+ggtitle("'Data archiving is a community norm.'")+scale_fill_manual(values=c(rep("blue",3),"grey",rep("red",3)))+scale_alpha_manual(values=c(1,.75,.5,1,.5,.75,1))+theme_bw()+xlab("Current policy")+ylab("Percentage")

p1

p2

```

The same plots side by side. Clearly, data sharing is considered more of a community standard than data archiving.
```{r, echo=FALSE, fig.width=10}

multiplot(p1, p2, cols=2)
```



## Attitudes towards data sharing and archiving by journal type and journal JDAP adoption date


The following plots show the responses regarding the attitudes towards data sharing and archiving for participants who (i) published in journals which have note adopted the JDAP so far ('No JDAP'), (ii) published in journals which had not _yet_ adopted the JDAP before publication ('Before JDAP'), and (iii) journals which had adopted the JDAP before publication ('After JDAP).

```{r, echo=FALSE}
x <- group_by(d, PolicyAdoptedAtPublication, Response=Q4) %>% dplyr::summarize(N.resp=length(StartDate)) %>% filter(!is.na(Response)) %>% dplyr::mutate(N.total=sum(N.resp), P.resp=N.resp/N.total, Policy=sprintf("%s\n(N=%d)", PolicyAdoptedAtPublication, N.total))
x <- x[order(x$Response, decreasing=T),]
p1 <- ggplot(data=x) + aes(Policy, P.resp*100, fill=Response, alpha=Response)+geom_bar(stat="identity")+ggtitle("'Data sharing is a community norm.'")+scale_fill_manual(values=c(rep("blue",3),"grey",rep("red",3)))+scale_alpha_manual(values=c(1,.75,.5,1,.5,.75,1))+theme_bw()+xlab("Policy at the time of publication")+ylab("Percentage")


x <- group_by(d, PolicyAdoptedAtPublication, Response=Q5) %>% dplyr::summarize(N.resp=length(StartDate)) %>% filter(!is.na(Response)) %>% dplyr::mutate(N.total=sum(N.resp), P.resp=N.resp/N.total, Policy=sprintf("%s\n(N=%d)", PolicyAdoptedAtPublication, N.total))
x <- x[order(x$Response, decreasing=T),]
p2 <- ggplot(data=x) + aes(Policy, P.resp*100, fill=Response, alpha=Response)+geom_bar(stat="identity")+ggtitle("'Data archiving is a community norm.'")+scale_fill_manual(values=c(rep("blue",3),"grey",rep("red",3)))+scale_alpha_manual(values=c(1,.75,.5,1,.5,.75,1))+theme_bw()+xlab("Policy at the time of publication")+ylab("Percentage")

p1

p2

```

The same plots side by side. Clearly, data sharing is considered more of a community standard than data archiving.
```{r, echo=FALSE, fig.width=10}

multiplot(p1, p2, cols=2)
```


```{r, message=FALSE, eval=FALSE}

library(MASS)


d$cPolicy <- ifelse(d$PolicyAdoptedAtPublication=="After JDAP", .5, -.5)
d$cDate <- as.yearmon(d$PublicationDate) %>% as.double %>% scale(., scale=F)

summary(d$cDate)

m <- polr(Q4 ~ 1 + cPolicy + cDate, data=d, Hess=TRUE)

summary(m)

multiplot(p1, p2, cols=2)
```
